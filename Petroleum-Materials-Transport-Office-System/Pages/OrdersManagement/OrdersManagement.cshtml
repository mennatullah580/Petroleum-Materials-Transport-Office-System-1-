@page "/OrdersManagement"
@model Petroleum_Materials_Transport_Office_System.Pages.OrdersManagement.IndexModel
@{
    ViewData["Title"] = "إدارة الطلبات";
}

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>إدارة الطلبات - نظام نقل المواد البترولية</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* الألوان بناءً على الواير فريم */
        :root {
            --bg-primary: #C8D9E6; /* خلفية الصفحة */
            --card-bg-light: #F5EFEB; /* خلفية البطاقات الفاتحة / الرئيسية */
            --card-bg-dark: #2F4456; /* خلفية البطاقات الداكنة / التفاصيل */
            --color-primary: #567C8D; /* لون أساسي */
            --color-secondary: #2F4456; /* لون ثانوي للنصوص الداكنة */
            --color-text-light: white; /* لون النص داخل البطاقات الداكنة */
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: var(--bg-primary);
            padding: 20px;
        }

        /* تعديل شكل حاوية الصفحة لتطابق الواير فريم */
        .page-container {
            background: var(--card-bg-light);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 2px solid var(--color-primary); /* إضافة حدود خفيفة */
            margin: auto;
            max-width: 1200px; /* لضبط عرض الصفحة */
        }

        /* إخفاء الهيدر القديم وتعديل العنوان الرئيسي */
        .page-header {
            display: none; /* إخفاء هيدر البداية */
        }

        h1.main-title {
            background: var(--card-bg-light); /* نفس خلفية الصفحة */
            color: var(--color-secondary);
            font-weight: bold;
            font-size: 2rem;
            margin-bottom: 20px;
            padding: 10px 0;
            text-align: right;
            border-bottom: 3px solid var(--color-primary);
        }

        .card {
            border: none;
            border-radius: 10px;
            box-shadow: none;
            margin-bottom: 20px;
            background: var(--card-bg-light);
        }

        .card-header {
            background: var(--card-bg-dark); /* تغيير لون الخلفية للداكن */
            color: var(--color-text-light);
            border-radius: 10px 10px 0 0 !important;
            padding: 10px 20px;
            font-weight: bold;
            font-size: 1.25rem;
            border-bottom: none;
        }

        .btn-primary {
            background: var(--card-bg-light); /* تغيير لون الزر للون الفاتح */
            color: var(--color-secondary);
            border: 2px solid var(--color-secondary); /* إضافة حدود */
            border-radius: 10px; /* جعل الحواف مستديرة قليلاً */
            padding: 10px 25px;
            font-weight: bold;
            font-size: 1.2rem;
        }

            .btn-primary:hover {
                background: var(--bg-primary);
                color: var(--color-secondary);
                border-color: var(--color-secondary);
            }

        .btn-secondary {
            background: var(--color-primary);
            color: var(--color-text-light);
            border: none;
            border-radius: 10px;
            padding: 10px 25px;
        }

            .btn-secondary:hover {
                background: var(--color-secondary);
            }

        .form-control, .form-select {
            border-radius: 10px;
            border: 1px solid var(--color-primary);
            padding: 8px 15px;
            background: var(--bg-primary); /* خلفية حقول الإدخال فاتحة */
        }

            .form-control:focus, .form-select:focus {
                border-color: var(--color-primary);
                box-shadow: 0 0 0 0.2rem rgba(86, 124, 141, 0.25);
            }

        /* تنسيق قسم البحث والفلترة ليتطابق مع الواير فريم */
        .search-filter-section .card-header {
            background: none;
            color: var(--color-secondary);
            border-bottom: 2px solid var(--color-primary);
            border-radius: 0 !important;
            padding: 0 0 10px 0;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        .search-filter-section .card-body {
            background: var(--bg-primary); /* تغيير خلفية البودي للون الوسط */
            border-radius: 0 0 10px 10px;
            padding: 20px;
        }

        /* تنسيق قائمة الطلبات لتشبه الأزرار/البطاقات في الواير فريم */
        .order-list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--card-bg-dark); /* خلفية داكنة كما في الواير فريم */
            color: var(--color-text-light);
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

            .order-list-item:hover {
                background: #3a5166; /* لون أغمق عند التمرير */
            }

        .order-detail-col {
            flex: 1;
            padding: 0 10px;
            text-align: center;
            font-size: 0.9rem;
        }

            .order-detail-col strong {
                display: block;
                font-size: 1.1rem;
            }

        .order-actions {
            flex-basis: 120px;
            display: flex;
            gap: 5px;
            justify-content: flex-end;
        }

        .badge.bg-success {
            background-color: #38a169 !important;
        }

        .badge.bg-warning {
            background-color: #f6ad55 !important;
        }

        .badge.bg-danger {
            background-color: #e53e3e !important;
        }


        /* تنسيق المودال (نموذج الإضافة) */
        .modal-content {
            border-radius: 15px;
            border: none;
        }

        .modal-header {
            background: var(--card-bg-dark); /* تغيير لون الخلفية للداكن */
            color: var(--color-text-light);
            border-radius: 15px 15px 0 0;
            border-bottom: none;
        }

        .modal-body {
            background: var(--card-bg-light); /* تغيير لون الخلفية للفاتح */
        }

        .form-section {
            background: var(--bg-primary); /* لون الوسط */
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid var(--card-bg-light); /* حدود فاتحة */
        }

            .form-section h5 {
                color: var(--color-secondary);
                margin-bottom: 15px;
                font-weight: bold;
            }

        .calculated-field {
            background: var(--card-bg-dark);
            color: var(--color-text-light);
            font-weight: bold;
            border-color: var(--color-secondary);
        }

        .modal-footer {
            background: var(--card-bg-light);
            border-radius: 0 0 15px 15px;
            border-top: none;
        }

        .btn-close-white {
            filter: brightness(0) invert(1);
        }
    </style>
</head>
<body>

    <div class="page-container">

        <h1 class="main-title">إداره الطلبات</h1>
        <div class="mb-4 mt-4">
            <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#createOrderModal">
                إنشاء طلب جديد
            </button>
        </div>

        <div class="card search-filter-section">
            <div class="card-header">
                البحث والفلترة
            </div>
            <div class="card-body">
                <form method="get">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">رقم الفاتورة</label>
                            <input type="text" class="form-control" asp-for="SearchInvoiceNumber" placeholder="ابحث برقم الفاتورة">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">جهة التحميل</label>
                            <select class="form-select" asp-for="SearchLoadingLocation">
                                <option value="">الكل</option>
                                @foreach (var location in Model.LoadingLocations)
                                {
                                    <option value="@location">@location</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">جهة التفريغ</label>
                            <select class="form-select" asp-for="SearchUnloadingLocation">
                                <option value="">الكل</option>
                                @foreach (var location in Model.UnloadingLocations)
                                {
                                    <option value="@location">@location</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">المقاول</label>
                            <select class="form-select" asp-for="SearchProviderName">
                                <option value="">الكل</option>
                                @foreach (var provider in Model.Providers)
                                {
                                    <option value="@provider">@provider</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">نوع الوقود</label>
                            <select class="form-select" asp-for="SearchPetroleumType">
                                <option value="">الكل</option>
                                @foreach (var type in Model.PetroleumTypes)
                                {
                                    <option value="@type">@type</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">الحالة</label>
                            <select class="form-select" asp-for="SearchStatus">
                                <option value="">الكل</option>
                                <option value="Pending">(قيد الانتظار)</option>
                                <option value="In Transit">(قيد النقل)</option>
                                <option value="Delivered">(تم التوصيل)</option>
                                <option value="Cancelled">(ملغي)</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">من تاريخ</label>
                            <input type="date" class="form-control" asp-for="SearchDateFrom">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">إلى تاريخ</label>
                            <input type="date" class="form-control" asp-for="SearchDateTo">
                        </div>
                    </div>
                    <div class="mt-3">
                        <button type="submit" class="btn btn-secondary"> بحث</button>
                        <a href="/OrdersManagement" class="btn btn-secondary"> إعادة تعيين</a>
                    </div>
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                قائمة الطلبات (@Model.Orders.Count طلب)
            </div>
            <div class="card-body p-3">

                <div class="order-list-item mb-2" style="background: var(--color-primary); font-weight: bold;">
                    <div class="order-detail-col">رقم الفاتورة</div>
                    <div class="order-detail-col">جهة التحميل</div>
                    <div class="order-detail-col">جهة التفريغ</div>
                    <div class="order-detail-col">نوع الوقود</div>
                    <div class="order-detail-col">المقاول</div>
                    <div class="order-detail-col">الحالة</div>
                    <div class="order-actions" style="flex-basis: 120px; visibility: hidden;">إجراءات</div>
                </div>

                @if (Model.Orders.Any())
                {
                    @foreach (var order in Model.Orders)
                    {
                        <div class="order-list-item">
                            <div class="order-detail-col">
                                <strong>@order.InvoiceNumber</strong>
                            </div>
                            <div class="order-detail-col">
                                @order.LoadingLocation
                            </div>
                            <div class="order-detail-col">
                                @order.UnloadingLocation
                            </div>
                            <div class="order-detail-col">
                                @order.PetroleumType
                            </div>
                            <div class="order-detail-col">
                                @order.ProviderName
                            </div>
                            <div class="order-detail-col">
                                @if (order.Status == "Delivered")
                                {
                                    <span class="badge bg-success">Delivered</span>
                                }
                                else if (order.Status == "In Transit")
                                {
                                    <span class="badge bg-info">In Transit</span>
                                }
                                else if (order.Status == "Pending")
                                {
                                    <span class="badge bg-warning text-dark">Pending</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger">Cancelled</span>
                                }
                            </div>
                            <div class="order-actions">
                                <a href="/OrdersManagement/ViewOrder/@order.OrderId" class="btn btn-sm btn-info" title="عرض">👁️</a>
                                <a href="/OrdersManagement/EditOrder/@order.OrderId" class="btn btn-sm btn-warning" title="تعديل">✏️</a>
                                <form method="post" asp-page-handler="DeleteOrder" asp-route-orderId="@order.OrderId" style="display: inline;">
                                    <button type="submit" class="btn btn-sm btn-danger" title="حذف" onclick="return confirm('هل أنت متأكد من حذف هذا الطلب؟')">🗑️</button>
                                </form>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="text-center py-4">
                        <p class="text-muted mb-0">لا توجد طلبات</p>
                    </div>
                }
            </div>
        </div>

        <div class="modal fade" id="createOrderModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">إنشاء طلب جديد</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <form method="post" asp-page-handler="CreateOrder" id="createOrderForm">
                        <div class="modal-body">

                            <div class="form-section">
                                <h5>المعلومات الأساسية</h5>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">رقم الفاتورة *</label>
                                        <input type="text" class="form-control" asp-for="NewOrder.InvoiceNumber" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">تاريخ الفاتورة *</label>
                                        <input type="date" class="form-control" asp-for="NewOrder.OrderDate" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">كود الجهة</label>
                                        <input type="text" class="form-control" asp-for="NewOrder.LocationCode">
                                    </div>
                                </div>
                            </div>

                            <div class="form-section">
                                <h5>المواقع ونوع الوقود</h5>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">جهة التحميل *</label>
                                        <select class="form-select" asp-for="NewOrder.LoadingLocation" required>
                                            <option value="">اختر...</option>
                                            @foreach (var location in Model.LoadingLocations)
                                            {
                                                <option value="@location">@location</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">جهة التفريغ *</label>
                                        <select class="form-select" asp-for="NewOrder.UnloadingLocation" required>
                                            <option value="">اختر...</option>
                                            @foreach (var location in Model.UnloadingLocations)
                                            {
                                                <option value="@location">@location</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">نوع الوقود *</label>
                                        <select class="form-select" asp-for="NewOrder.PetroleumType" required>
                                            <option value="">اختر...</option>
                                            @foreach (var type in Model.PetroleumTypes)
                                            {
                                                <option value="@type">@type</option>
                                            }
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="form-section">
                                <h5>الكميات</h5>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">كمية التحميل (لتر) *</label>
                                        <input type="number" step="0.01" class="form-control" asp-for="NewOrder.LoadingQuantity" id="loadingQty" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">كمية التفريغ (لتر) *</label>
                                        <input type="number" step="0.01" class="form-control" asp-for="NewOrder.UnloadingQuantity" id="unloadingQty" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">العجز (لتر)</label>
                                        <input type="number" step="0.01" class="form-control calculated-field" asp-for="NewOrder.Shortage" id="shortage" readonly>
                                    </div>
                                </div>
                            </div>

                            <div class="form-section">
                                <h5>المقاول والسيارة</h5>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">المقاول *</label>
                                        <select class="form-select" asp-for="NewOrder.ProviderName" required>
                                            <option value="">اختر...</option>
                                            @foreach (var provider in Model.Providers)
                                            {
                                                <option value="@provider">@provider</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">رقم العربة *</label>
                                        <select class="form-select" asp-for="NewOrder.VehiclePlateNumber" required>
                                            <option value="">اختر...</option>
                                            @foreach (var vehicle in Model.Vehicles)
                                            {
                                                <option value="@vehicle">@vehicle</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">اسم السائق</label>
                                        <input type="text" class="form-control" asp-for="NewOrder.DriverName">
                                    </div>
                                </div>
                            </div>

                            <div class="form-section">
                                <h5>الأسعار والمبالغ</h5>
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label">سعر الشركة (للتر)</label>
                                        <input type="number" step="0.01" class="form-control" asp-for="NewOrder.CompanyPrice" id="companyPrice">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">سعر المقاول (للتر)</label>
                                        <input type="number" step="0.01" class="form-control" asp-for="NewOrder.ProviderPrice" id="providerPrice">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">إجمالي الشركة</label>
                                        <input type="number" step="0.01" class="form-control calculated-field" asp-for="NewOrder.CompanyTotal" id="companyTotal" readonly>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">إجمالي المقاول</label>
                                        <input type="number" step="0.01" class="form-control calculated-field" asp-for="NewOrder.ProviderTotal" id="providerTotal" readonly>
                                    </div>
                                </div>
                            </div>

                            <div class="form-section">
                                <h5>الخصومات</h5>
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label">الضريبة (5%)</label>
                                        <input type="number" step="0.01" class="form-control calculated-field" asp-for="NewOrder.TaxAmount" id="taxAmount" readonly>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">رسم الدمغة</label>
                                        <input type="number" step="0.01" class="form-control" asp-for="NewOrder.StampFee" value="50" id="stampFee">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">رسوم GPS</label>
                                        <input type="number" step="0.01" class="form-control" asp-for="NewOrder.GPSFee" id="gpsFee">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">إجمالي الخصومات</label>
                                        <input type="number" step="0.01" class="form-control calculated-field" asp-for="NewOrder.TotalDeductions" id="totalDeductions" readonly>
                                    </div>
                                </div>
                            </div>

                            <div class="form-section">
                                <h5>الدفعات</h5>
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label">السلفة</label>
                                        <input type="number" step="0.01" class="form-control" asp-for="NewOrder.AdvancePayment" id="advancePayment">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">العهدة</label>
                                        <input type="number" step="0.01" class="form-control" asp-for="NewOrder.CustodyAmount" id="custodyAmount">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">الصافي</label>
                                        <input type="number" step="0.01" class="form-control calculated-field" asp-for="NewOrder.NetAmount" id="netAmount" readonly>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">المتبقي</label>
                                        <input type="number" step="0.01" class="form-control calculated-field" asp-for="NewOrder.Balance" id="balance" readonly>
                                    </div>
                                </div>
                            </div>

                            <div class="form-section">
                                <h5>الحالة والتسليم</h5>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">تاريخ التسليم *</label>
                                        <input type="date" class="form-control" asp-for="NewOrder.DeliveryDate" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">الحالة *</label>
                                        <select class="form-select" asp-for="NewOrder.Status" required>
                                            <option value="">-- اختر الحالة --</option>
                                            <option value="Pending">(قيد الانتظار)</option>
                                            <option value="In Transit">(قيد النقل)</option>
                                            <option value="Delivered">(تم التوصيل)</option>
                                            <option value="Cancelled">(ملغي)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                            <button type="submit" class="btn btn-primary">حفظ الطلب</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    </div> @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show fixed-top mt-3 mx-auto" role="alert" style="max-width: 500px; background: var(--bg-primary); color: var(--color-secondary); border: 1px solid var(--color-primary);">
            <strong>✓</strong> @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const loadingQty = document.getElementById('loadingQty');
            const unloadingQty = document.getElementById('unloadingQty');
            const shortage = document.getElementById('shortage');
            const companyPrice = document.getElementById('companyPrice');
            const providerPrice = document.getElementById('providerPrice');
            const companyTotal = document.getElementById('companyTotal');
            const providerTotal = document.getElementById('providerTotal');
            const taxAmount = document.getElementById('taxAmount');
            const stampFee = document.getElementById('stampFee');
            const gpsFee = document.getElementById('gpsFee');
            const totalDeductions = document.getElementById('totalDeductions');
            const advancePayment = document.getElementById('advancePayment');
            const custodyAmount = document.getElementById('custodyAmount');
            const netAmount = document.getElementById('netAmount');
            const balance = document.getElementById('balance');

            function calculateAll() {
                const loading = parseFloat(loadingQty.value) || 0;
                const unloading = parseFloat(unloadingQty.value) || 0;
                shortage.value = (loading - unloading).toFixed(2);

                const cPrice = parseFloat(companyPrice.value) || 0;
                const pPrice = parseFloat(providerPrice.value) || 0;
                companyTotal.value = (unloading * cPrice).toFixed(2);
                providerTotal.value = (unloading * pPrice).toFixed(2);

                const pTotal = parseFloat(providerTotal.value) || 0;
                taxAmount.value = (pTotal * 0.05).toFixed(2);

                const tax = parseFloat(taxAmount.value) || 0;
                const stamp = parseFloat(stampFee.value) || 0;
                const gps = parseFloat(gpsFee.value) || 0;
                totalDeductions.value = (tax + stamp + gps).toFixed(2);

                const advance = parseFloat(advancePayment.value) || 0;
                const custody = parseFloat(custodyAmount.value) || 0;
                const deductions = parseFloat(totalDeductions.value) || 0;
                const net = pTotal - deductions - advance - custody;
                netAmount.value = net.toFixed(2);
                balance.value = net.toFixed(2);
            }

            [loadingQty, unloadingQty, companyPrice, providerPrice, stampFee, gpsFee, advancePayment, custodyAmount].forEach(element => {
                element.addEventListener('input', calculateAll);
            });
        });
    </script>

</body>
</html>